# /workspace/yolo/ultralytics/cfg/models/new/yolov12-sod-fusion.yaml
# 主要功能简介: YOLO-SOD-Fusion混合架构配置 - 融合CNN、Mamba、Transformer的小目标检测SOTA模型
# 基于2025年最新研究：MambaFusion骨干、BiCAN颈部、InterpIoU损失、DetectStable头部
# 架构改进：引入Mamba/VMamba、BiFormer注意力、RT-DETR辅助头、增强P2小目标检测

# 基本参数
nc: 10                 # 类别数(VisDrone常用10类)
depth_multiple: 0.33   # 深度缩放系数
width_multiple: 0.50   # 宽度缩放系数
ch: 3                  # 输入通道数

# Backbone: MambaFusion增强骨干网络
# 策略：在深层阶段嵌入MFBlock/VimBlock，融合CNN局部特征与Mamba长程依赖
backbone:
  # [from, number, module, args]
  - [-1, 1, Conv, [64, 3, 2]]      # 0-P1/2: 基础卷积下采样
  - [-1, 1, Conv, [128, 3, 2]]     # 1-P2/4: 进一步下采样
  - [-1, 3, C2f, [128, True]]      # 2: C2f特征提取(P2)
  - [-1, 1, Conv, [256, 3, 2]]     # 3-P3/8: 下采样到P3
  - [-1, 6, C2f, [256, True]]      # 4: C2f深层提取(P3)
  - [-1, 1, Conv, [512, 3, 2]]     # 5-P4/16: 下采样到P4
  - [-1, 3, C2f, [512, True]]      # 6: C2f深层提取(P4)
  - [-1, 1, MFBlock, [512, 256]]   # 7: MambaFusion增强P4特征(长程依赖建模)
  - [-1, 1, VimBlock, [512, 256]]  # 8: VMamba增强P4特征(视觉状态空间建模)
  - [-1, 1, Conv, [1024, 3, 2]]    # 9-P5/32: 下采样到P5
  - [-1, 2, C2f, [1024, True]]     # 10: C2f顶层语义(P5)
  - [-1, 1, MFBlock, [1024, 512]]  # 11: MambaFusion增强P5特征(全局上下文)
  - [-1, 1, VimBlock, [1024, 512]] # 12: VMamba增强P5特征(视觉长程建模)
  - [-1, 1, SPPF, [1024, 5]]       # 13: SPPF聚合

# Neck: 双向上下文聚合网络(BiCAN) + BiFormer稀疏注意力
# 设计：BiFPN基础 + P2小目标检测层 + BiFormer上下文增强模块
neck:
  # P2小目标检测层：直接连接骨干早期特征，保留最高分辨率细节
  - [-1, 1, Conv, [256, 1, 1]]     # 14: P2特征通道调整
  
  # 自顶向下路径：P5 -> P4 -> P3 -> P2 (语义信息传播)
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 15: P5上采到P4
  - [[-1, 8], 1, Concat, [1]]                   # 16: 与P4主干特征拼接
  - [-1, 3, C2f, [512, True]]                   # 17: 融合细化(P4)
  
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 18: P4上采到P3
  - [[-1, 4], 1, Concat, [1]]                   # 19: 与P3主干特征拼接
  - [-1, 3, C2f, [256, True]]                   # 20: 融合细化(P3)
  
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 21: P3上采到P2
  - [[-1, 2], 1, Concat, [1]]                   # 22: 与P2主干特征拼接
  - [-1, 3, C2f, [128, True]]                   # 23: 融合细化(P2)
  
  # 上下文增强模块：BiFormer稀疏注意力 + RAFB增强P2小目标检测能力
  - [-1, 1, BiLevelRoutingAttentionFusionBlock, [128, 64, 4, 0.5]]  # 24: BiFormer稀疏注意力
  - [-1, 1, RecurrentAttentionFusionBlock, [128, 64, 4, 0.5]]      # 25: RAFB上下文聚合
  
  # 自底向上路径：P2 -> P3 -> P4 -> P5 (细节信息传播)
  - [-1, 1, Conv, [256, 3, 2]]                  # 26: P2降采回P3
  - [[-1, 20], 1, Concat, [1]]                  # 27: 与P3融合
  - [-1, 3, C2f, [256, True]]                   # 28: 融合细化(P3)
  
  - [-1, 1, Conv, [512, 3, 2]]                  # 29: P3降采回P4
  - [[-1, 17], 1, Concat, [1]]                  # 30: 与P4融合
  - [-1, 3, C2f, [512, True]]                   # 31: 融合细化(P4)
  
  - [-1, 1, Conv, [1024, 3, 2]]                 # 32: P4降采回P5
  - [[-1, 13], 1, Concat, [1]]                  # 33: 与P5融合
  - [-1, 3, C2f, [1024, True]]                  # 34: 融合细化(P5)

# Head: 四尺度稳定检测头(DetectStable)
# 输出：P2(高分辨率小目标) + P3/P4/P5(多尺度检测)
head:
  - [[25, 28, 31, 34], 1, DetectStable, [nc]]  # 35: DetectStable四尺度检测

# RT-DETR辅助头：训练期启用，推理时关闭
# 用于集合匹配蒸馏，强化拥挤/小目标的去重与召回
aux_head:
  - [[25, 28, 31, 34], 1, RTDETRDecoder, [nc, 300, 4]]  # 36: RT-DETR辅助头(仅训练期启用)

# 损失函数配置：启用InterpIoU提升定位精度
loss:
  box: 7.5                 # 边界框损失权重
  cls: 0.5                 # 分类损失权重
  dfl: 1.5                 # DFL损失权重
  iou_mode: "interpiou"    # 使用InterpIoU损失函数
  interpiou_samples: 8     # InterpIoU采样点数
  aux_weight: 0.3          # RT-DETR辅助头损失权重(训练期)
