# /workspace/yolo/ultralytics/cfg/models/new/yolov12-sod-fusion-v5-all.yaml
# YOLO-SOD-Fusion完整版本 - 包含所有增强模块的完整四尺度检测配置
# 集成MambaBlock、SwinBlock、BiFormer注意力、RT-DETR辅助头等所有先进组件
# 专为小目标和复杂场景检测设计的SOTA架构

# 基本参数配置
nc: 10                 # 类别数（VisDrone数据集10类）
depth_multiple: 0.33   # 深度缩放系数
width_multiple: 0.50   # 宽度缩放系数
ch: 3                  # 输入通道数

# 骨干网络：融合CNN、Mamba和Transformer的混合架构
backbone:
  # [from, number, module, args]
  - [-1, 1, Conv, [64, 3, 2]]          # 0-P1/2: 基础卷积下采样
  - [-1, 1, Conv, [128, 3, 2]]         # 1-P2/4: 下采样到P2层
  - [-1, 3, C2f, [128, True]]          # 2: C2f特征提取（P2层）
  - [-1, 1, Conv, [256, 3, 2]]         # 3-P3/8: 下采样到P3层  
  - [-1, 6, C2f, [256, True]]          # 4: C2f深层特征提取（P3层）
  - [-1, 1, Conv, [512, 3, 2]]         # 5-P4/16: 下采样到P4层
  - [-1, 3, C2f, [512, True]]          # 6: C2f深层特征提取（P4层）
  - [-1, 1, MambaBlock, [256, 2]]      # 7: Mamba块增强P4特征（长序列建模）
  - [-1, 1, Conv, [1024, 3, 2]]        # 8-P5/32: 下采样到P5层
  - [-1, 2, C2f, [1024, True]]         # 9: C2f顶层语义提取（P5层）
  - [-1, 1, SwinBlock, [8, 7]]         # 10: Swin Transformer增强P5特征（窗口注意力）
  - [-1, 1, SPPF, [1024, 5]]           # 11: SPPF空间金字塔池化

# 颈部网络：双向特征聚合网络，包含P2小目标检测支持
neck:
  # 自顶向下特征传播路径：P5 -> P4 -> P3 -> P2
  - [-1, 1, Conv, [512, 1, 1]]                    # 12: P5通道调整
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]   # 13: P5上采样到P4
  - [[-1, 6], 1, Concat, [1]]                    # 14: P4特征融合
  - [-1, 3, C2f, [512, True]]                    # 15: P4特征细化
  
  - [-1, 1, Conv, [256, 1, 1]]                   # 16: P4通道调整
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]   # 17: P4上采样到P3
  - [[-1, 4], 1, Concat, [1]]                    # 18: P3特征融合
  - [-1, 3, C2f, [256, True]]                    # 19: P3特征细化
  
  - [-1, 1, Conv, [128, 1, 1]]                   # 20: P3通道调整
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]   # 21: P3上采样到P2
  - [[-1, 2], 1, Concat, [1]]                    # 22: P2特征融合
  - [-1, 3, C2f, [128, True]]                    # 23: P2特征细化
  - [-1, 1, SwinBlock, [4, 7]]                   # 24: P2层Swin注意力增强（小目标）

  # 自底向上特征传播路径：P2 -> P3 -> P4 -> P5
  - [-1, 1, Conv, [256, 3, 2]]                   # 25: P2下采样回P3
  - [[-1, 19], 1, Concat, [1]]                   # 26: P3特征整合
  - [-1, 3, C2f, [256, True]]                    # 27: P3特征融合
  
  - [-1, 1, Conv, [512, 3, 2]]                   # 28: P3下采样回P4
  - [[-1, 15], 1, Concat, [1]]                   # 29: P4特征整合
  - [-1, 3, C2f, [512, True]]                    # 30: P4特征融合
  
  - [-1, 1, Conv, [1024, 3, 2]]                  # 31: P4下采样回P5
  - [[-1, 11], 1, Concat, [1]]                   # 32: P5特征整合
  - [-1, 2, C2f, [1024, True]]                   # 33: P5特征融合

# 检测头：四尺度稳定检测头，支持P2-P5所有尺度
head:
  - [[24, 27, 30, 33], 1, DetectStable, [nc]]    # 34: 四尺度检测头（P2/P3/P4/P5）

# RT-DETR辅助头：训练时启用，提升小目标检测性能
aux_head:
  - [[24, 27, 30, 33], 1, DETRAuxHead, [nc]]     # 35: RT-DETR辅助检测头

# 损失函数配置：针对小目标优化的损失权重
loss:
  box: 7.5                 # 边界框回归损失权重
  cls: 0.5                 # 分类损失权重  
  dfl: 1.5                 # 分布焦点损失权重
  iou_mode: "interpiou"    # 使用InterpIoU损失提升定位精度
  interpiou_samples: 8     # InterpIoU插值采样点数
  aux_weight: 0.3          # 辅助头损失权重（训练期）
